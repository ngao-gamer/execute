local TweenService = game:GetService('TweenService') 
local RunService = game:GetService('RunService')
local Players = game:GetService('Players')

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild('PlayerGui')
local NotificationPrefix = 'ExecutedNotification_'
local MaxNotifications = 3 -- GIỚI HẠN TỐI ĐA 3 THÔNG BÁO
local Duration = 2 -- Thời gian hiển thị 2 giây
local FrameHeight = 45 -- Chiều cao cố định của Frame
local Padding = 10 -- Khoảng cách giữa các thông báo

-- Mảng theo dõi các thông báo đang tồn tại (Sử dụng ScreenGui làm key, nil làm value)
-- **Quan trọng:** Dùng để theo dõi thứ tự và sự tồn tại của các thông báo
local ActiveNotifications = {} 

-- Tính toán vị trí Y cuối cùng của thông báo thứ N (tính từ trên xuống)
local function getTargetPosition(index)
    -- Vị trí gốc (Top Right): UDim2.new(1, -320, 0, 20)
    -- Vị trí dịch chuyển xuống: index * (FrameHeight + Padding)
    local yOffset = 20 + (index - 1) * (FrameHeight + Padding)
    return UDim2.new(1, -270, 0, yOffset) -- Rộng 250px -> offset -270 (250 + 20 margin)
end

-- Hàm quan trọng: Tính toán lại và Dịch chuyển tất cả thông báo lên/xuống
local function recalculateAndShiftAll()
    -- Lấy tất cả các ScreenGui đang tồn tại có tiền tố
    local currentNotifications = {}
    for _, child in ipairs(PlayerGui:GetChildren()) do
        if child.Name:sub(1, #NotificationPrefix) == NotificationPrefix and child:IsA('ScreenGui') then
            table.insert(currentNotifications, child)
        end
    end

    -- Sắp xếp chúng theo thứ tự tạo (DisplayName, giả sử tick() là tăng dần)
    table.sort(currentNotifications, function(a, b)
        return tonumber(a.Name:gsub(NotificationPrefix, '')) < tonumber(b.Name:gsub(NotificationPrefix, ''))
    end)
    
    -- Áp dụng Tween cho từng thông báo để dịch chuyển lên
    for index, notification in ipairs(currentNotifications) do
        local frame = notification:FindFirstChild('Frame')
        if frame then
            local targetPos = getTargetPosition(index)
            local ShiftInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            TweenService:Create(frame, ShiftInfo, { Position = targetPos }):Play()
        end
    end
    
    -- Quản lý giới hạn tối đa (MaxNotifications)
    if #currentNotifications > MaxNotifications then
        -- Lấy thông báo cũ nhất (thông báo đầu tiên trong mảng đã sắp xếp)
        local oldest = currentNotifications[1]
        if oldest then
            -- Tắt ngay lập tức để tạo chỗ trống
            local frame = oldest:FindFirstChild('Frame')
            if frame then
                frame.Visible = false
            end
            oldest:Destroy()
            -- Sau khi hủy, hàm này sẽ tự gọi lại (hoặc được gọi ngay sau đó)
            -- để dịch chuyển các thông báo còn lại lên, nhưng logic tiếp theo sẽ đảm bảo điều đó.
        end
    end
end

-- Hàm xử lý hiệu ứng đóng (Tweening) và dọn dẹp
local function dismissNotification(notification)
    local Frame = notification:FindFirstChild('Frame')
    if not Frame or not Frame.Parent then return end 

    -- BƯỚC 1: Prep-Exit (Nhún nhẹ ra ngoài)
    local PrepExitTime = 0.15
    local PrepExitInfo = TweenInfo.new(PrepExitTime, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    
    local PrepExitGoal = {
        Position = UDim2.new(1.05, -270, Frame.Position.Y.Scale, Frame.Position.Y.Offset) 
    }
    
    local PrepExitTween = TweenService:Create(Frame, PrepExitInfo, PrepExitGoal)
    PrepExitTween:Play()
    PrepExitTween.Completed:Wait() 
    
    -- BƯỚC 2: Retreat (Trượt hẳn ra ngoài)
    local RetreatTime = 0.3
    local RetreatInfo = TweenInfo.new(RetreatTime, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
    
    local RetreatGoal = {
        Position = UDim2.new(1.1, 0, Frame.Position.Y.Scale, Frame.Position.Y.Offset) 
    }
    
    local RetreatTween = TweenService:Create(Frame, RetreatInfo, RetreatGoal)
    RetreatTween:Play()
    RetreatTween.Completed:Wait() 
    
    -- Dọn dẹp
    notification:Destroy()
    
    -- QUAN TRỌNG: Dịch chuyển các thông báo còn lại lên lấp đầy khoảng trống
    recalculateAndShiftAll()
end

-- Logic chính để tạo và chạy thông báo
local function createNotification()
    -- 1. TẠO ScreenGui
    local Notification = Instance.new('ScreenGui')
    Notification.Name = NotificationPrefix .. tostring(math.floor(tick() * 1000))
    Notification.DisplayOrder = 999 

    -- 2. TẠO Khung chính (Frame)
    local Frame = Instance.new('Frame')
    Frame.Size = UDim2.new(0, 250, 0, FrameHeight) -- Kích thước nhỏ gọn: 250x45
    Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Frame.BorderSizePixel = 3 
    Frame.BorderColor3 = Color3.fromRGB(30, 144, 255) -- DodgerBlue
    Frame.Draggable = false 
    Frame.Parent = Notification
    
    local Corner = Instance.new('UICorner')
    Corner.CornerRadius = UDim.new(0, 8) 
    Corner.Parent = Frame

    -- 3. TẠO Label Nội dung
    local Header = Instance.new('TextLabel')
    Header.Text = 'Purium'
    Header.TextColor3 = Color3.fromRGB(30, 144, 255) -- DodgerBlue
    Header.TextSize = 14
    Header.Font = Enum.Font.SourceSansBold
    Header.BackgroundTransparency = 1
    Header.Size = UDim2.new(1, 0, 0.5, 0)
    Header.TextXAlignment = Enum.TextXAlignment.Left
    Header.TextYAlignment = Enum.TextYAlignment.Top
    Header.Position = UDim2.new(0.05, 0, 0.1, 0)
    Header.Parent = Frame
    
    local Content = Instance.new('TextLabel')
    Content.Text = 'Executed Script'
    Content.TextColor3 = Color3.fromRGB(173, 255, 47) -- Lime Green
    Content.TextSize = 16
    Content.Font = Enum.Font.SourceSansBold
    Content.BackgroundTransparency = 1
    Content.Size = UDim2.new(1, 0, 0.5, 0)
    Content.TextXAlignment = Enum.TextXAlignment.Left
    Content.TextYAlignment = Enum.TextYAlignment.Bottom
    Content.Position = UDim2.new(0.05, 0, 0.5, 0)
    Content.Parent = Frame
    
    -- 4. TẠO Thanh Tiến Trình (3px Lime)
    local ProgressBar = Instance.new('Frame')
    ProgressBar.Name = "ProgressBar"
    ProgressBar.Size = UDim2.new(1, 0, 0, 3) -- Chiều cao 3px
    ProgressBar.Position = UDim2.new(0, 0, 1, -3)
    ProgressBar.BackgroundColor3 = Color3.fromRGB(173, 255, 47) -- Lime Green
    ProgressBar.BorderSizePixel = 0
    ProgressBar.Parent = Frame

    Notification.Parent = PlayerGui
    
    -- ********************************************
    -- 5. LOGIC XUẤT HIỆN VÀ NHÚN NHẢY (ENTRY BOUNCE)
    -- Vị trí khởi điểm (ngoài màn hình, Y target đúng)
    local index = 1 -- Sẽ được cập nhật ngay sau khi thêm vào danh sách
    local startYPos = getTargetPosition(index).Y.Offset 
    Frame.Position = UDim2.new(1.1, 0, 0, startYPos) 
    
    -- THÊM VÀO DANH SÁCH & TÍNH TOÁN LẠI VỊ TRÍ
    recalculateAndShiftAll()

    -- Vị trí mục tiêu cuối cùng sau khi tính toán lại
    local finalTargetPos = Frame.Position

    -- BƯỚC 1: Overshoot (Trượt quá)
    local OvershootTime = 0.2
    local OvershootInfo = TweenInfo.new(OvershootTime, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    
    local OvershootGoal = {
        Position = UDim2.new(1, -280, finalTargetPos.Y.Scale, finalTargetPos.Y.Offset) -- Trượt quá 10px
    }
    
    local OvershootTween = TweenService:Create(Frame, OvershootInfo, OvershootGoal)
    OvershootTween:Play()
    OvershootTween.Completed:Wait()
    
    -- BƯỚC 2: Retract (Rút về vị trí cuối)
    local RetractTime = 0.15
    local RetractInfo = TweenInfo.new(RetractTime, Enum.EasingStyle.Quart, Enum.EasingDirection.In)
    
    local RetractGoal = {
        Position = UDim2.new(1, -270, finalTargetPos.Y.Scale, finalTargetPos.Y.Offset) -- Vị trí cuối 
    }
    
    local RetractTween = TweenService:Create(Frame, RetractInfo, RetractGoal)
    RetractTween:Play()
    
    -- ********************************************
    -- 6. LOGIC THANH TIẾN TRÌNH VÀ TỰ ĐÓNG (4 giây)
    
    -- Hoạt ảnh thanh tiến trình (Từ 1 về 0)
    local ProgressInfo = TweenInfo.new(Duration, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local ProgressGoal = { Size = UDim2.new(0, 0, 0, 3) }
    
    local ProgressTween = TweenService:Create(ProgressBar, ProgressInfo, ProgressGoal)
    
    -- Chờ hoạt ảnh Retract hoàn tất trước khi chạy tiến trình
    RetractTween.Completed:Wait() 
    
    ProgressTween:Play()
    ProgressTween.Completed:Wait()
    
    -- Tự động đóng sau khi tiến trình hết
    dismissNotification(Notification)
end

-- Chạy logic tạo thông báo
createNotification()


---

Mã này là phiên bản cuối cùng và đã được thiết kế để giải quyết lỗi xếp chồng triệt để. Bạn có thể sử dụng toàn bộ nội dung này để cập nhật file Lua trên GitHub của mình. Nếu bạn có bất kỳ thắc mắc nào khác về code, cứ hỏi tôi nhé!
