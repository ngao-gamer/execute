local TweenService = game:GetService('TweenService') 
local RunService = game:GetService('RunService')

local Player = game:GetService('Players').LocalPlayer
local PlayerGui = Player:WaitForChild('PlayerGui')
local NotificationPrefix = 'ExecutedNotification_'
local MaxNotifications = 4
local Duration = 4 -- Thời gian hiển thị 4 giây
local StackOffset = 10 -- Khoảng cách giữa các thông báo

-- 1. TÌM VÀ SẮP XẾP THÔNG BÁO HIỆN TẠI
-- Trả về một mảng chứa tất cả ScreenGui thông báo hiện tại
local function getExistingNotifications()
    local notifications = {}
    for _, child in ipairs(PlayerGui:GetChildren()) do
        if child.Name:sub(1, #NotificationPrefix) == NotificationPrefix and child:IsA('ScreenGui') then
            table.insert(notifications, child)
        end
    end
    -- Sắp xếp theo vị trí Y (từ trên xuống dưới)
    table.sort(notifications, function(a, b)
        return a.Frame.Position.Y.Offset < b.Frame.Position.Y.Offset
    end)
    return notifications
end

-- 2. DỊCH CHUYỂN CÁC THÔNG BÁO LÊN
local function shiftNotificationsUp(yOffsetToFill)
    local notifications = getExistingNotifications()
    local shiftAmount = Frame.Size.Y.Offset + StackOffset -- Chiều cao thông báo + khoảng cách
    
    for _, notif in ipairs(notifications) do
        -- Chỉ dịch chuyển các thông báo nằm dưới khoảng trống
        if notif.Frame.Position.Y.Offset > yOffsetToFill then
             local newY = notif.Frame.Position.Y.Offset - shiftAmount
             local TweenInfoShift = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
             local TweenShift = TweenService:Create(notif.Frame, TweenInfoShift, {Position = UDim2.new(notif.Frame.Position.X.Scale, notif.Frame.Position.X.Offset, 0, newY)})
             TweenShift:Play()
        end
    end
end

-- 3. HỦY THÔNG BÁO CŨ NHẤT VÀ DỊCH CHUYỂN
local notifications = getExistingNotifications()

if #notifications >= MaxNotifications then
    local oldestNotification = notifications[1] -- Thông báo trên cùng (cũ nhất)
    
    -- Ghi lại vị trí Y để biết khoảng trống cần lấp đầy
    local yToFill = oldestNotification.Frame.Position.Y.Offset
    
    -- Hủy thông báo cũ nhất
    oldestNotification:Destroy() 
    
    -- Sau khi hủy, dịch chuyển tất cả thông báo khác lên
    shiftNotificationsUp(yToFill)
end

-- 4. TÍNH TOÁN VỊ TRÍ MỚI VÀ TẠO THÔNG BÁO MỚI
local notificationsAfterCleanup = getExistingNotifications()
local newYOffset = 20 -- Vị trí Y ban đầu (cách đỉnh 20px)

if #notificationsAfterCleanup > 0 then
    -- Nếu có thông báo, đặt thông báo mới ngay dưới thông báo thấp nhất
    local lastNotifFrame = notificationsAfterCleanup[#notificationsAfterCleanup].Frame
    newYOffset = lastNotifFrame.Position.Y.Offset + lastNotifFrame.Size.Y.Offset + StackOffset
end

local Notification = Instance.new('ScreenGui')
Notification.Name = NotificationPrefix .. tostring(math.floor(tick() * 1000))
Notification.DisplayOrder = 999 

local Frame = Instance.new('Frame')
Frame.Size = UDim2.new(0, 250, 0, 45) 
-- Vị trí ban đầu: Hoàn toàn ngoài màn hình bên phải
Frame.Position = UDim2.new(1.1, 0, 0, newYOffset) 
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Frame.BorderSizePixel = 3 
Frame.BorderColor3 = Color3.fromRGB(30, 144, 255) 
Frame.Draggable = true 
Frame.Parent = Notification

-- Khai báo TargetPos để sử dụng trong animations
local TargetPos = UDim2.new(1, -270, 0, newYOffset) -- 270 = 250 (width) + 20 (padding)

local Corner = Instance.new('UICorner')
Corner.CornerRadius = UDim.new(0, 8) 
Corner.Parent = Frame

-- Thanh Tiến trình (Progress Bar)
local ProgressBar = Instance.new('Frame')
ProgressBar.Size = UDim2.new(1, 0, 0, 3) -- Chiều cao 3px
ProgressBar.Position = UDim2.new(0, 0, 1, -3) 
ProgressBar.BackgroundColor3 = Color3.fromRGB(173, 255, 47) 
ProgressBar.BorderSizePixel = 0
ProgressBar.Parent = Frame

-- Label Nội dung chính
local Content = Instance.new('TextLabel')
Content.Text = 'Purium\nExecuted Script \xE2\x9C\x93' 
Content.TextColor3 = Color3.fromRGB(50, 255, 50) 
Content.TextSize = 16
Content.Font = Enum.Font.SourceSansBold
Content.TextYAlignment = Enum.TextYAlignment.Center
Content.TextWrapped = true
Content.BackgroundTransparency = 1
Content.Size = UDim2.new(1, 0, 1, -3) 
Content.Position = UDim2.new(0, 0, 0, 0)
Content.Parent = Frame

Notification.Parent = PlayerGui

-- *****************************************************************
-- 5. HOẠT ẢNH XUẤT HIỆN VÀ BIẾN MẤT
-- *****************************************************************

local function playEntryAnimation()
    -- Vị trí trượt quá mục tiêu (10px overshoot)
    local OvershootPos = UDim2.new(1, -280, 0, newYOffset) 

    -- Tween 1: Trượt quá đà (Overshoot)
    local Tween1Info = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local Tween1 = TweenService:Create(Frame, Tween1Info, {Position = OvershootPos})
    Tween1:Play()
    Tween1.Completed:Wait()

    -- Tween 2: Rút về vị trí cuối cùng (Bounce)
    local Tween2Info = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local Tween2 = TweenService:Create(Frame, Tween2Info, {Position = TargetPos})
    Tween2:Play()
    Tween2.Completed:Wait()
end

local function dismissNotification()
    if not Frame.Parent then return end 

    -- Tween 3: Thanh tiến trình (4 giây)
    local ProgressTweenInfo = TweenInfo.new(Duration, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local ProgressTween = TweenService:Create(ProgressBar, ProgressTweenInfo, {Size = UDim2.new(0, 0, 0, 3)})
    ProgressTween:Play()
    
    ProgressTween.Completed:Wait()

    -- Lấy vị trí Y trước khi hủy để dùng cho hoạt ảnh dịch chuyển lên
    local yToFill = Frame.Position.Y.Offset 

    -- Tween 4 (Prep-Exit): Nhúc nhích ra ngoài (10px bump)
    local BumpOutPos = UDim2.new(1, -260, Frame.Position.Y.Scale, Frame.Position.Y.Offset)
    local BumpTweenInfo = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local BumpTween = TweenService:Create(Frame, BumpTweenInfo, {Position = BumpOutPos})
    BumpTween:Play()
    BumpTween.Completed:Wait()

    -- Tween 5 (Final Retreat): Trượt ra khỏi màn hình
    local DismissTime = 0.3
    local DismissInfo = TweenInfo.new(DismissTime, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local Goal = {
        Position = UDim2.new(1.1, 0, Frame.Position.Y.Scale, Frame.Position.Y.Offset) 
    }
    
    local TweenFinal = TweenService:Create(Frame, DismissInfo, Goal)
    TweenFinal:Play()
    
    TweenFinal.Completed:Wait() 
    Notification:Destroy()

    -- Kích hoạt dịch chuyển lên sau khi thông báo này biến mất hoàn toàn
    shiftNotificationsUp(yToFill)
end

-- Bắt đầu hoạt ảnh xuất hiện
playEntryAnimation()

-- Bắt đầu quá trình tự hủy
dismissNotification()
